<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlaci√≥n 3D-2D Angiograf√≠a Coronaria | Premium</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            overflow: hidden;
        }
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #00d4ff;
        }
        .header h1 {
            font-size: 1.5rem;
            color: #00d4ff;
            display: inline-block;
        }
        .premium-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr auto;
            height: calc(100vh - 80px);
            gap: 10px;
            padding: 10px;
        }
        .viewer-3d, .viewer-2d {
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        .viewer-3d { border: 2px solid #00d4ff; }
        .viewer-2d { 
            border: 2px solid #ff4757;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        .viewer-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 10;
        }
        .viewer-3d .viewer-label { color: #00d4ff; border: 1px solid #00d4ff; }
        .viewer-2d .viewer-label { color: #ff4757; border: 1px solid #ff4757; }
        #canvas3d { width: 100%; height: 100%; display: block; }
        .angio-video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .video-controls {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            border: 1px solid #ff4757;
            z-index: 30;
        }
        .video-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.3s;
        }
        .video-btn:hover { color: #ff4757; transform: scale(1.2); }
        .error-message {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid #ff4757;
            padding: 15px;
            border-radius: 8px;
            margin: 10px;
            text-align: left;
        }
        .controls-panel {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #00d4ff;
            display: flex;
            gap: 30px;
            overflow-x: auto;
        }
        .control-section { min-width: 200px; }
        .control-section h3 {
            color: #00d4ff;
            font-size: 0.9rem;
            margin-bottom: 10px;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 5px;
        }
        .projection-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .projection-btn {
            padding: 10px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .projection-btn:hover { background: rgba(0, 212, 255, 0.4); transform: translateY(-2px); }
        .projection-btn.active { background: #ff4757; border-color: #ff4757; }
        .view-controls { display: flex; flex-direction: column; gap: 8px; }
        .view-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        .view-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .view-btn.active { background: #00d4ff; border-color: #00d4ff; color: #000; }
        .angle-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            border: 1px solid #ffd700;
            color: #ffd700;
            font-weight: bold;
        }
        .case-option {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .case-option:hover { background: rgba(255, 255, 255, 0.1); border-color: #00d4ff; }
        .case-option.active { background: rgba(0, 212, 255, 0.2); border-color: #00d4ff; }
        .case-title { font-weight: bold; color: #00d4ff; font-size: 0.9rem; margin-bottom: 3px; }
        .case-desc { font-size: 0.75rem; color: #aaa; }
        .annotation {
            position: absolute;
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 25;
        }
        .sync-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 0, 0.8);
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .video-status {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(255, 165, 0, 0.9);
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 15;
        }
        .url-display {
            position: absolute;
            top: 90px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px;
            border-radius: 5px;
            font-size: 0.65rem;
            max-width: 350px;
            word-break: break-all;
            border: 1px solid #ffd700;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Correlaci√≥n 3D-2D Angiograf√≠a Coronaria <span class="premium-badge">PREMIUM PRO</span></h1>
    </div>

    <div class="container">
        <div class="viewer-3d">
            <div class="viewer-label">üéØ MODELO 3D</div>
            <div class="sync-indicator" id="syncIndicator">‚óè SINCRONIZADO</div>
            <canvas id="canvas3d"></canvas>
            <div class="angle-info" id="angleInfo">Vista: Inicial</div>
        </div>

        <div class="viewer-2d">
            <div class="viewer-label">üì∏ ANGIOGRAF√çA</div>
            <div class="video-status" id="videoStatus" style="display: none;">‚è≥ Cargando...</div>
            <div id="angioViewer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center; color: #666; padding: 20px;">
                    <h3 style="color: #00d4ff; margin-bottom: 10px;">Selecciona una proyecci√≥n</h3>
                    <p>Los videos se cargar√°n autom√°ticamente</p>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="control-section" style="min-width: 250px;">
                <h3>üìã Casos Cl√≠nicos</h3>
                <div class="case-option active" onclick="selectCase('normal')">
                    <div class="case-title">Anatom√≠a Normal</div>
                    <div class="case-desc">Dominancia derecha est√°ndar</div>
                </div>
            </div>

            <div class="control-section">
                <h3>üìê Proyecciones Angiogr√°ficas</h3>
                <div class="projection-buttons">
                    <button class="projection-btn" onclick="setProjection('RAO30')">RAO 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO45')">LAO 45¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO60')">LAO 60¬∞</button>
                    <button class="projection-btn" onclick="setProjection('RAO30-CRAN30')">RAO 30¬∞ CRAN 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO45-CRAN30')">LAO 45¬∞ CRAN 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO45-CAUD30')">LAO 45¬∞ CAUD 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('AP-CRAN30')">AP CRAN 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('AP-CAUD30')">AP CAUD 30¬∞</button>
                </div>
            </div>

            <div class="control-section">
                <h3>‚öôÔ∏è Visualizaci√≥n</h3>
                <div class="view-controls">
                    <button class="view-btn active" id="btnAll" onclick="toggleArtery('all')">Todas las Arterias</button>
                    <button class="view-btn" id="btnLCA" onclick="toggleArtery('lca')">Sistema Izquierdo</button>
                    <button class="view-btn" id="btnRCA" onclick="toggleArtery('rca')">Sistema Derecho</button>
                    <button class="view-btn" onclick="toggleHeart()">ü´Ä Coraz√≥n</button>
                    <button class="view-btn" onclick="toggleRotation()" id="btnRotate">‚ñ∂Ô∏è Rotar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const BASE_VIDEO_URL = 'https://raw.githubusercontent.com/danielmaytahuari/coronarias-3d-angiografia/main/videos/';
        
        const projectionDatabase = {
            'normal': {
                'RAO30': { video: BASE_VIDEO_URL + 'RAO28.mp4', desc: 'RAO 30¬∞ - RCA proximal', cam: {x:12,y:3,z:12} },
                'RAO30-CRAN30': { video: BASE_VIDEO_URL + 'RAO29CRA30.mp4', desc: 'RAO 30¬∞ CRAN 30¬∞ - Bifurcaci√≥n LM', cam: {x:10,y:12,z:10} },
                'LAO45': { video: BASE_VIDEO_URL + 'LAO28-RCA.mp4', desc: 'LAO 45¬∞ - LAD completa', cam: {x:-12,y:3,z:12} },
                'LAO45-CRAN30': { video: BASE_VIDEO_URL + 'LAO27CRA22-RCA.mp4', desc: 'LAO 45¬∞ CRAN 30¬∞ - LAD proximal', cam: {x:-10,y:12,z:10} },
                'LAO45-CAUD30': { video: BASE_VIDEO_URL + 'LAO42CAU23.mp4', desc: 'LAO 45¬∞ CAUD 30¬∞ - LCx', cam: {x:-10,y:-10,z:12} },
                'AP-CRAN30': { video: BASE_VIDEO_URL + 'CRA33.mp4', desc: 'AP CRAN 30¬∞ - LAD distal', cam: {x:0,y:15,z:12} },
                'AP-CAUD30': { video: BASE_VIDEO_URL + 'CAU34.mp4', desc: 'AP CAUD 30¬∞ - RCA distal', cam: {x:0,y:-12,z:15} },
                'LAO60': { video: BASE_VIDEO_URL + 'LAO42CRA23.mp4', desc: 'LAO 60¬∞', cam: {x:-15,y:3,z:10} }
            }
        };

        let scene, camera, renderer, coronaries, isRotating = false, currentCase = 'normal';

        function init() {
            const canvas = document.getElementById('canvas3d');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1929);
            camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(0, 8, 20);
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
            mainLight.position.set(10, 10, 10);
            scene.add(mainLight);

            coronaries = new THREE.Group();
            scene.add(coronaries);
            createCoronaryModel();
            
            const gridHelper = new THREE.GridHelper(30, 30, 0x00d4ff, 0x003344);
            gridHelper.position.y = -8;
            scene.add(gridHelper);

            let isDragging = false, prevMouse = {x:0,y:0};
            canvas.addEventListener('mousedown', (e) => { isDragging = true; prevMouse = {x:e.clientX, y:e.clientY}; });
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    coronaries.rotation.y += (e.clientX - prevMouse.x) * 0.01;
                    coronaries.rotation.x += (e.clientY - prevMouse.y) * 0.01;
                    prevMouse = {x:e.clientX, y:e.clientY};
                }
            });
            canvas.addEventListener('mouseup', () => isDragging = false);
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z = Math.max(8, Math.min(40, camera.position.z + e.deltaY * 0.02));
            });

            window.addEventListener('resize', () => {
                camera.aspect = canvas.clientWidth / canvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            });

            animate();
        }

        function createCoronaryModel() {
            const heartGeo = new THREE.SphereGeometry(3, 32, 32);
            heartGeo.scale(1, 1.3, 0.9);
            const heart = new THREE.Mesh(heartGeo, new THREE.MeshPhongMaterial({color:0x8b0000, transparent:true, opacity:0.25}));
            heart.name = 'heartMesh';
            coronaries.add(heart);

            const createArtery = (points, r, c, g) => {
                const curve = new THREE.CatmullRomCurve3(points);
                const geo = new THREE.TubeGeometry(curve, 64, r, 16, false);
                const mat = new THREE.MeshPhongMaterial({color:c, shininess:100, emissive:c, emissiveIntensity:0.1});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.userData.group = g;
                coronaries.add(mesh);
            };

            createArtery([new THREE.Vector3(-1,3,2), new THREE.Vector3(-1.5,2.5,2.2)], 0.18, 0xff0000, 'lca');
            createArtery([new THREE.Vector3(-1.5,2.5,2.2), new THREE.Vector3(-1.8,1,2.5), new THREE.Vector3(-1.5,-1,2.6), new THREE.Vector3(-1,-3,2.4), new THREE.Vector3(-0.6,-4.5,2.0)], 0.14, 0xff0000, 'lca');
            createArtery([new THREE.Vector3(-1.5,2.5,2.2), new THREE.Vector3(-2.5,2,0.5), new THREE.Vector3(-3.5,0.5,-1), new THREE.Vector3(-3.2,-1,-1.8)], 0.12, 0xff0000, 'lca');
            createArtery([new THREE.Vector3(1,3,2), new THREE.Vector3(3,2,0.5), new THREE.Vector3(4,0,-1), new THREE.Vector3(3.5,-1.5,-2), new THREE.Vector3(2,-2.5,-2.3)], 0.14, 0x4444ff, 'rca');
            createArtery([new THREE.Vector3(2,-2.5,-2.3), new THREE.Vector3(0.5,-3.5,-2), new THREE.Vector3(-0.5,-4.5,-1.5)], 0.11, 0x6666ff, 'rca');
        }

        function setProjection(proj) {
            document.querySelectorAll('.projection-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            const data = projectionDatabase[currentCase]?.[proj];
            if (!data) return;

            const vs = document.getElementById('videoStatus');
            vs.style.display = 'block';
            vs.textContent = '‚è≥ Cargando...';
            vs.style.background = 'rgba(255, 165, 0, 0.9)';

            camera.position.set(data.cam.x, data.cam.y, data.cam.z);
            camera.lookAt(0, 0, 0);
            document.getElementById('angleInfo').textContent = `Vista: ${proj}`;

            console.log('üé¨ Cargando:', data.video);

            document.getElementById('angioViewer').innerHTML = `
                <video class="angio-video" id="angioVideo" controls loop muted playsinline preload="metadata" 
                       style="width:100%;height:100%;object-fit:contain;background:#000;">
                    <source src="${data.video}" type="video/mp4">
                </video>
                <div class="video-controls">
                    <button class="video-btn" onclick="playVideo()">‚ñ∂Ô∏è</button>
                    <button class="video-btn" onclick="pauseVideo()">‚è∏Ô∏è</button>
                    <button class="video-btn" onclick="restartVideo()">‚èÆÔ∏è</button>
                </div>
                <div class="annotation" style="bottom: 80px; left: 50%; transform: translateX(-50%);">${data.desc}</div>
                <div class="url-display">üîó ${data.video}</div>
            `;

            const video = document.getElementById('angioVideo');
            video.onloadeddata = () => { vs.textContent = '‚úÖ Listo'; vs.style.background = 'rgba(0,255,0,0.9)'; console.log('‚úÖ Video cargado'); };
            video.onerror = () => { 
                vs.textContent = '‚ùå Error'; 
                vs.style.background = 'rgba(255,71,87,0.9)';
                console.error('‚ùå Error al cargar:', data.video);
                document.getElementById('angioViewer').innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå No se pudo cargar: ${proj}</h3>
                        <p><strong>URL:</strong> ${data.video}</p>
                        <button onclick="window.open('${data.video}','_blank')" style="margin-top:10px;padding:10px;background:#00d4ff;border:none;border-radius:5px;cursor:pointer;">Abrir URL</button>
                    </div>
                `;
            };
        }

        function playVideo() { document.getElementById('angioVideo')?.play(); }
        function pauseVideo() { document.getElementById('angioVideo')?.pause(); }
        function restartVideo() { const v = document.getElementById('angioVideo'); if(v) { v.currentTime = 0; v.play(); } }
        function selectCase(c) { currentCase = c; document.querySelectorAll('.case-option').forEach(e => e.classList.remove('active')); event.target.closest('.case-option').classList.add('active'); }
        function toggleArtery(t) {
            ['btnAll','btnLCA','btnRCA'].forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById('btn'+(t==='all'?'All':t==='lca'?'LCA':'RCA')).classList.add('active');
            coronaries.children.forEach(c => { if(c.userData.group) c.visible = (t==='all' || c.userData.group===t); });
        }
        function toggleHeart() { coronaries.children.forEach(c => { if(c.name==='heartMesh') c.visible = !c.visible; }); }
        function toggleRotation() { isRotating = !isRotating; document.getElementById('btnRotate').textContent = isRotating ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Rotar'; }
        function animate() { requestAnimationFrame(animate); if(isRotating) coronaries.rotation.y += 0.003; renderer.render(scene, camera); }

        window.addEventListener('load', init);
        console.log('üè• Sistema cargado');
        console.log('Base URL:', BASE_VIDEO_URL);
    </script>
</body>
</html>
