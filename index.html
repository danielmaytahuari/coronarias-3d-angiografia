<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Avanzado de Radiolog√≠a Intervencionista 3D</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            overflow: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #00d4ff;
            z-index: 1000;
        }

        .header-left h1 {
            font-size: 1.5rem;
            color: #00d4ff;
            margin-bottom: 3px;
        }

        .header-left p {
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 15px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .header-btn:hover {
            background: #00d4ff;
            color: #000;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar-left {
            width: 280px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            overflow-y: auto;
            border-right: 2px solid #00d4ff;
        }

        .viewer-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .viewer-main {
            flex: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
        }

        #canvas3d {
            width: 100%;
            height: 100%;
            display: block;
        }

        .bottom-panel {
            height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 2px solid #00d4ff;
            display: flex;
            overflow-x: auto;
        }

        .angiography-view {
            min-width: 250px;
            padding: 10px;
            border-right: 1px solid #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .angiography-view:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .angiography-view img {
            width: 100%;
            height: 130px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #00d4ff;
        }

        .angiography-view p {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #00d4ff;
        }

        .sidebar-right {
            width: 320px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            overflow-y: auto;
            border-left: 2px solid #00d4ff;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #00d4ff;
        }

        .control-panel h3 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }

        .btn.active {
            background: linear-gradient(135deg, #ff4757 0%, #cc3344 100%);
            color: #fff;
        }

        .btn-small {
            width: calc(50% - 4px);
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-small:nth-child(2n) {
            margin-right: 0;
        }

        .slider-control {
            margin-bottom: 15px;
        }

        .slider-control label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #a0a0a0;
        }

        .slider-control input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #333;
            outline: none;
        }

        .slider-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
        }

        .slider-value {
            display: inline-block;
            float: right;
            color: #00d4ff;
            font-weight: bold;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #00d4ff;
        }

        .info-card h4 {
            color: #00d4ff;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .info-card p {
            font-size: 0.8rem;
            line-height: 1.4;
            color: #d0d0d0;
        }

        .info-card ul {
            margin-left: 15px;
            margin-top: 6px;
            font-size: 0.8rem;
        }

        .measurements-list {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .measurement-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-size: 0.8rem;
        }

        .measurement-item:last-child {
            border-bottom: none;
        }

        .catheter-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .catheter-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255, 170, 0, 0.2);
            border: 1px solid #ffaa00;
            border-radius: 5px;
            color: #ffaa00;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.75rem;
        }

        .catheter-btn:hover {
            background: #ffaa00;
            color: #000;
        }

        .catheter-btn.active {
            background: #ffaa00;
            color: #000;
        }

        .top-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            pointer-events: none;
        }

        .top-controls > div {
            pointer-events: all;
        }

        .info-overlay {
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #00d4ff;
            backdrop-filter: blur(10px);
        }

        .info-overlay-right {
            text-align: right;
        }

        .info-overlay p {
            font-size: 0.85rem;
            margin-bottom: 3px;
            color: #d0d0d0;
        }

        .info-overlay .highlight {
            color: #00d4ff;
            font-weight: bold;
        }

        .center-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 2px solid #00d4ff;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.5;
        }

        .center-crosshair::before,
        .center-crosshair::after {
            content: '';
            position: absolute;
            background: #00d4ff;
        }

        .center-crosshair::before {
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            transform: translateY(-50%);
        }

        .center-crosshair::after {
            left: 50%;
            top: 10%;
            bottom: 10%;
            width: 2px;
            transform: translateX(-50%);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #00d4ff;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #00d4ff;
            margin-bottom: 20px;
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ff4757;
        }

        .stenosis-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff4757;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .legend {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .legend h4 {
            color: #00d4ff;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 25px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .legend-text {
            font-size: 0.75rem;
            color: #d0d0d0;
        }

        .checkbox-group {
            margin: 10px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 0.85rem;
            color: #d0d0d0;
            cursor: pointer;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0099cc;
        }

        .color-picker-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover {
            border-color: #fff;
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: #00d4ff;
            box-shadow: 0 0 10px #00d4ff;
        }

        @media (max-width: 1200px) {
            .sidebar-left, .sidebar-right {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar-left, .sidebar-right {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
            
            .bottom-panel {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>ü´Ä Sistema Avanzado de Radiolog√≠a Intervencionista 3D</h1>
            <p>Hospital Alberto Sabogal Sologuren - EsSalud | Servicio de Hemodinamia</p>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="exportImage()">üì∏ Capturar</button>
            <button class="header-btn" onclick="toggleFullscreen()">‚õ∂ Pantalla Completa</button>
            <button class="header-btn" onclick="showHelp()">‚ùì Ayuda</button>
        </div>
    </div>

    <div class="main-container">
        <!-- Sidebar Izquierdo -->
        <div class="sidebar-left">
            <div class="control-panel">
                <h3>üéØ Vistas Angiogr√°ficas</h3>
                <button class="btn btn-small" onclick="setAngiographicView('RAO30')">RAO 30¬∞</button>
                <button class="btn btn-small" onclick="setAngiographicView('LAO45')">LAO 45¬∞</button>
                <button class="btn btn-small" onclick="setAngiographicView('RAO30_CRAN')">RAO 30¬∞ Cran</button>
                <button class="btn btn-small" onclick="setAngiographicView('LAO45_CRAN')">LAO 45¬∞ Cran</button>
                <button class="btn btn-small" onclick="setAngiographicView('RAO30_CAUD')">RAO 30¬∞ Caud</button>
                <button class="btn btn-small" onclick="setAngiographicView('LAO45_CAUD')">LAO 45¬∞ Caud</button>
                <button class="btn btn-small" onclick="setAngiographicView('AP_CRAN')">AP Craneal</button>
                <button class="btn btn-small" onclick="setAngiographicView('AP_CAUD')">AP Caudal</button>
                <button class="btn btn-small" onclick="setAngiographicView('LATERAL')">Lateral</button>
                <button class="btn btn-small" onclick="setAngiographicView('SPIDER')">Spider</button>
            </div>

            <div class="control-panel">
                <h3>üîç Visualizaci√≥n</h3>
                <button class="btn active" id="btnAll" onclick="toggleArteryVisibility('all')">Todas las Arterias</button>
                <button class="btn" id="btnLCA" onclick="toggleArteryVisibility('lca')">Coronaria Izquierda</button>
                <button class="btn" id="btnRCA" onclick="toggleArteryVisibility('rca')">Coronaria Derecha</button>
                
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="chkLabels" checked onchange="toggleLabels()">
                        <label for="chkLabels">Mostrar Etiquetas</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chkHeart" checked onchange="toggleHeart()">
                        <label for="chkHeart">Mostrar Coraz√≥n</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chkGrid" onchange="toggleGrid()">
                        <label for="chkGrid">Mostrar Cuadr√≠cula</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chkStenosis" onchange="toggleStenosis()">
                        <label for="chkStenosis">Mostrar Estenosis</label>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <h3>‚öôÔ∏è Controles</h3>
                <button class="btn" onclick="resetView()">üîÑ Restablecer Vista</button>
                <button class="btn" onclick="toggleRotation()" id="btnRotation">‚è∏Ô∏è Pausar Rotaci√≥n</button>
                <button class="btn" onclick="toggleMeasurement()">üìè Modo Medici√≥n</button>
            </div>

            <div class="legend">
                <h4>Leyenda de Colores</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff4444;"></div>
                    <div class="legend-text">Tronco y LAD</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6666;"></div>
                    <div class="legend-text">Circunfleja (LCx)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4444ff;"></div>
                    <div class="legend-text">Coronaria Derecha</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffaa00;"></div>
                    <div class="legend-text">Diagonales</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff88;"></div>
                    <div class="legend-text">Marginales</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff4757;"></div>
                    <div class="legend-text">Estenosis</div>
                </div>
            </div>
        </div>

        <!-- √Årea Principal -->
        <div class="viewer-container">
            <div class="viewer-main">
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>Cargando sistema 3D avanzado...</p>
                </div>
                
                <canvas id="canvas3d"></canvas>
                
                <div class="top-controls">
                    <div class="info-overlay">
                        <p><span class="highlight">Vista:</span> <span id="currentView">Frontal</span></p>
                        <p><span class="highlight">Rotaci√≥n:</span> <span id="rotationAngle">0¬∞</span></p>
                        <p><span class="highlight">Zoom:</span> <span id="zoomLevel">100%</span></p>
                    </div>
                    
                    <div class="info-overlay info-overlay-right">
                        <p><span class="highlight">Modo:</span> <span id="currentMode">Visualizaci√≥n</span></p>
                        <p><span class="highlight">Arterias:</span> <span id="visibleArteries">Todas</span></p>
                    </div>
                </div>
                
                <div class="center-crosshair" id="crosshair" style="display: none;"></div>
            </div>

            <!-- Panel Inferior con Proyecciones Angiogr√°ficas -->
            <div class="bottom-panel">
                <div class="angiography-view" onclick="setAngiographicView('RAO30')">
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); height: 130px; border-radius: 5px; border: 2px solid #00d4ff; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">‚ÜóÔ∏è</div>
                            <div style="font-size: 0.8rem; color: #00d4ff;">RAO 30¬∞</div>
                        </div>
                    </div>
                    <p>RAO 30¬∞</p>
                </div>

                <div class="angiography-view" onclick="setAngiographicView('LAO45')">
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); height: 130px; border-radius: 5px; border: 2px solid #00d4ff; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">‚ÜñÔ∏è</div>
                            <div style="font-size: 0.8rem; color: #00d4ff;">LAO 45¬∞</div>
                        </div>
                    </div>
                    <p>LAO 45¬∞</p>
                </div>

                <div class="angiography-view" onclick="setAngiographicView('RAO30_CRAN')">
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); height: 130px; border-radius: 5px; border: 2px solid #00d4ff; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">‚¨à</div>
                            <div style="font-size: 0.8rem; color: #00d4ff;">RAO Craneal</div>
                        </div>
                    </div>
                    <p>RAO 30¬∞ Craneal</p>
                </div>

                <div class="angiography-view" onclick="setAngiographicView('LAO45_CAUD')">
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); height: 130px; border-radius: 5px; border: 2px solid #00d4ff; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">‚¨ã</div>
                            <div style="font-size: 0.8rem; color: #00d4ff;">LAO Caudal</div>
                        </div>
                    </div>
                    <p>LAO 45¬∞ Caudal</p>
                </div>

                <div class="angiography-view" onclick="setAngiographicView('SPIDER')">
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); height: 130px; border-radius: 5px; border: 2px solid #00d4ff; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">üï∑Ô∏è</div>
                            <div style="font-size: 0.8rem; color: #00d4ff;">Spider View</div>
                        </div>
                    </div>
                    <p>Vista Spider</p>
                </div>

                <div class="angiography-view" onclick="setAngiographicView('AP_CRAN')">
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); height: 130px; border-radius: 5px; border: 2px solid #00d4ff; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">‚¨ÜÔ∏è</div>
                            <div style="font-size: 0.8rem; color: #00d4ff;">AP Craneal</div>
                        </div>
                    </div>
                    <p>AP Craneal</p>
                </div>
            </div>
        </div>

        <!-- Sidebar Derecho -->
        <div class="sidebar-right">
            <div class="control-panel">
                <h3>ü©∫ Simulaci√≥n de Cat√©teres</h3>
                <div class="catheter-controls">
                    <button class="catheter-btn" onclick="addCatheter('JL4')">JL4</button>
                    <button class="catheter-btn" onclick="addCatheter('JR4')">JR4</button>
                    <button class="catheter-btn" onclick="addCatheter('AL1')">AL1</button>
                </div>
                <div class="catheter-controls">
                    <button class="catheter-btn" onclick="addCatheter('EBU')">EBU</button>
                    <button class="catheter-btn" onclick="addCatheter('MP')">MP</button>
                    <button class="catheter-btn" onclick="addCatheter('clear')">‚ùå Limpiar</button>
                </div>
                
                <div class="slider-control">
                    <label>Avance del Cat√©ter <span class="slider-value" id="catheterProgress">0%</span></label>
                    <input type="range" min="0" max="100" value="0" id="catheterSlider" oninput="updateCatheterProgress(this.value)">
                </div>
            </div>

            <div class="control-panel">
                <h3>üìè Mediciones</h3>
                <div class="measurements-list" id="measurementsList">
                    <p style="text-align: center; color: #666; font-size: 0.8rem;">No hay mediciones</p>
                </div>
                <button class="btn" onclick="clearMeasurements()">üóëÔ∏è Limpiar Mediciones</button>
            </div>

            <div class="control-panel">
                <h3>üé® Apariencia</h3>
                <div class="slider-control">
                    <label>Opacidad Coraz√≥n <span class="slider-value" id="heartOpacity">30%</span></label>
                    <input type="range" min="0" max="100" value="30" oninput="updateHeartOpacity(this.value)">
                </div>
                
                <div class="slider-control">
                    <label>Grosor Arterias <span class="slider-value" id="arteryThickness">100%</span></label>
                    <input type="range" min="50" max="200" value="100" oninput="updateArteryThickness(this.value)">
                </div>

                <label style="display: block; margin: 10px 0 5px 0; font-size: 0.85rem; color: #a0a0a0;">Color de Fondo</label>
                <div class="color-picker-group">
                    <div class="color-option active" style="background: #0a0a0a;" onclick="changeBackground('#0a0a0a')"></div>
                    <div class="color-option" style="background: #1a1a2e;" onclick="changeBackground('#1a1a2e')"></div>
                    <div class="color-option" style="background: #0f3460;" onclick="changeBackground('#0f3460')"></div>
                    <div class="color-option" style="background: #16213e;" onclick="changeBackground('#16213e')"></div>
                    <div class="color-option" style="background: #2c3e50;" onclick="changeBackground('#2c3e50')"></div>
                </div>
            </div>

            <div class="control-panel">
                <h3>üìä Informaci√≥n del Paciente</h3>
                <div class="info-card">
                    <h4>Datos de Ejemplo</h4>
                    <p><strong>Nombre:</strong> Simulaci√≥n</p>
                    <p><strong>Edad:</strong> -- a√±os</p>
                    <p><strong>Indicaci√≥n:</strong> Educacional</p>
                    <p><strong>Fecha:</strong> <span id="currentDate"></span></p>
                </div>
            </div>

            <div class="info-card" style="background: rgba(255, 170, 0, 0.1); border-left-color: #ffaa00;">
                <h4>üí° Tips R√°pidos</h4>
                <ul style="font-size: 0.75rem;">
                    <li>Click + arrastrar para rotar</li>
                    <li>Scroll para zoom</li>
                    <li>Doble click para centrar</li>
                    <li>Click derecho para men√∫</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal de Ayuda -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('helpModal')">&times;</span>
            <h2>üìñ Gu√≠a de Uso del Sistema</h2>
            
            <h3 style="color: #00d4ff; margin-top: 20px;">Controles B√°sicos</h3>
            <ul>
                <li><strong>Rotaci√≥n:</strong> Click izquierdo + arrastrar</li>
                <li><strong>Zoom:</strong> Rueda del mouse o scroll</li>
                <li><strong>Paneo:</strong> Click derecho + arrastrar</li>
                <li><strong>Centrar:</strong> Doble click en el modelo</li>
            </ul>

            <h3 style="color: #00d4ff; margin-top: 20px;">Vistas Angiogr√°ficas Est√°ndar</h3>
            <ul>
                <li><strong>RAO 30¬∞:</strong> Oblicua anterior derecha - Visualiza LAD proximal</li>
                <li><strong>LAO 45¬∞:</strong> Oblicua anterior izquierda - Visualiza circunfleja</li>
                <li><strong>RAO Craneal:</strong> Mejor vista de LAD medio y distal</li>
                <li><strong>LAO Caudal:</strong> √ìptima para el tronco com√∫n izquierdo</li>
                <li><strong>Spider View:</strong> Vista craneal extrema para bifurcaci√≥n</li>
            </ul>

            <h3 style="color: #00d4ff; margin-top: 20px;">Funciones Avanzadas</h3>
            <ul>
                <li><strong>Simulaci√≥n de Cat√©teres:</strong> Selecciona el tipo y ajusta su posici√≥n</li>
                <li><strong>Mediciones:</strong> Activa el modo y haz click en dos puntos</li>
                <li><strong>Visualizaci√≥n Selectiva:</strong> Oculta/muestra arterias espec√≠ficas</li>
                <li><strong>Captura de Pantalla:</strong> Guarda la vista actual en alta resoluci√≥n</li>
            </ul>

            <h3 style="color: #00d4ff; margin-top: 20px;">Aplicaciones Cl√≠nicas</h3>
            <ul>
                <li>Planificaci√≥n pre-procedimiento</li>
                <li>Educaci√≥n de pacientes y residentes</li>
                <li>Presentaciones de casos cl√≠nicos</li>
                <li>Evaluaci√≥n de estenosis y anatom√≠a coronaria</li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Variables globales
        let scene, camera, renderer, heart, arteries = {}, labels = [], catheters = [];
        let isRotating = true, measurementMode = false, currentCatheter = null;
        let measurements = [], stenosisMarkers = [];
        let controls = {
            isDragging: false,
            previousMousePosition: { x: 0, y: 0 },
            rotationSpeed: 0.01,
            zoomLevel: 15
        };

        // Datos de estenosis predefinidas para simulaci√≥n
        const stenosisData = [
            { position: new THREE.Vector3(-0.8, 0.5, 2.3), severity: 70, artery: 'LAD Proximal' },
            { position: new THREE.Vector3(1.5, 1.2, 1.5), severity: 50, artery: 'RCA Media' }
        ];

        function init() {
            // Configurar escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.Fog(0x0a0a0a, 20, 50);

            // Configurar c√°mara
            const canvas = document.getElementById('canvas3d');
            camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(0, 5, 15);
            camera.lookAt(0, 0, 0);

            // Configurar renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas, 
                antialias: true,
                preserveDrawingBuffer: true 
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Iluminaci√≥n mejorada
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(10, 10, 10);
            directionalLight1.castShadow = true;
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-10, 5, -10);
            scene.add(directionalLight2);

            const pointLight = new THREE.PointLight(0x00d4ff, 0.3, 50);
            pointLight.position.set(0, 0, 10);
            scene.add(pointLight);

            // Crear elementos
            createHeart();
            createCoronaryArteries();
            createLabels();
            createStenosisMarkers();

            // Event listeners
            setupEventListeners();

            // Actualizar fecha
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-PE');

            // Ocultar loading
            document.getElementById('loading').style.display = 'none';

            // Iniciar animaci√≥n
            animate();
        }

        function createHeart() {
            heart = new THREE.Group();

            // Crear forma de coraz√≥n m√°s realista
            const heartShape = new THREE.Shape();
            
            // Ventr√≠culo izquierdo (m√°s grande)
            const leftVentricle = new THREE.SphereGeometry(1.8, 32, 32);
            const lvMaterial = new THREE.MeshPhongMaterial({
                color: 0x880000,
                transparent: true,
                opacity: 0.3,
                shininess: 30,
                side: THREE.DoubleSide
            });
            const lvMesh = new THREE.Mesh(leftVentricle, lvMaterial);
            lvMesh.scale.set(1.3, 1.4, 1);
            lvMesh.position.set(-0.3, -0.2, 0);
            heart.add(lvMesh);

            // Ventr√≠culo derecho (m√°s peque√±o)
            const rightVentricle = new THREE.SphereGeometry(1.4, 32, 32);
            const rvMesh = new THREE.Mesh(rightVentricle, lvMaterial);
            rvMesh.scale.set(1, 1.2, 0.9);
            rvMesh.position.set(0.8, -0.1, 0.3);
            heart.add(rvMesh);

            // Aur√≠culas
            const atrium = new THREE.SphereGeometry(0.9, 32, 32);
            const atriumMaterial = new THREE.MeshPhongMaterial({
                color: 0xaa0000,
                transparent: true,
                opacity: 0.25,
                shininess: 30
            });
            
            const leftAtrium = new THREE.Mesh(atrium, atriumMaterial);
            leftAtrium.position.set(-0.5, 1.3, -0.2);
            heart.add(leftAtrium);

            const rightAtrium = new THREE.Mesh(atrium, atriumMaterial);
            rightAtrium.scale.set(0.9, 0.9, 0.9);
            rightAtrium.position.set(0.7, 1.2, 0);
            heart.add(rightAtrium);

            scene.add(heart);
        }

        function createCoronaryArteries() {
            // Sistema Coronario Izquierdo
            
            // Tronco Com√∫n Izquierdo (LM)
            arteries.lm = createArterySegment(
                new THREE.Vector3(0, 1.8, 2.2),
                new THREE.Vector3(-0.5, 1.4, 2.4),
                0.18,
                0xff4444,
                'lca',
                'LM'
            );

            // Descendente Anterior (LAD)
            const ladPoints = [
                new THREE.Vector3(-0.5, 1.4, 2.4),
                new THREE.Vector3(-0.9, 0.8, 2.5),
                new THREE.Vector3(-1.1, 0, 2.4),
                new THREE.Vector3(-1.2, -0.8, 2.2),
                new THREE.Vector3(-1.1, -1.6, 2),
                new THREE.Vector3(-0.8, -2.2, 1.8)
            ];
            arteries.lad = createCurvedArtery(ladPoints, 0.14, 0xff4444, 'lca', 'LAD');

            // Ramas Diagonales
            arteries.d1 = createArterySegment(
                new THREE.Vector3(-0.9, 0.8, 2.5),
                new THREE.Vector3(-1.6, 0.9, 2.8),
                0.09,
                0xffaa00,
                'lca',
                'D1'
            );

            arteries.d2 = createArterySegment(
                new THREE.Vector3(-1.1, 0, 2.4),
                new THREE.Vector3(-1.9, -0.1, 2.7),
                0.08,
                0xffaa00,
                'lca',
                'D2'
            );

            // Ramas Septales
            arteries.s1 = createArterySegment(
                new THREE.Vector3(-1.1, 0, 2.4),
                new THREE.Vector3(-0.8, -0.2, 1.8),
                0.06,
                0xff8844,
                'lca',
                'S1'
            );

            // Circunfleja (LCx)
            const lcxPoints = [
                new THREE.Vector3(-0.5, 1.4, 2.4),
                new THREE.Vector3(-1, 1.3, 1.8),
                new THREE.Vector3(-1.6, 1, 1),
                new THREE.Vector3(-2, 0.6, 0),
                new THREE.Vector3(-2.2, 0.2, -0.8),
                new THREE.Vector3(-2, -0.3, -1.4)
            ];
            arteries.lcx = createCurvedArtery(lcxPoints, 0.12, 0xff6666, 'lca', 'LCx');

            // Marginales Obtusas
            arteries.om1 = createArterySegment(
                new THREE.Vector3(-1, 1.3, 1.8),
                new THREE.Vector3(-2.1, 1.5, 2),
                0.09,
                0x00ff88,
                'lca',
                'OM1'
            );

            arteries.om2 = createArterySegment(
                new THREE.Vector3(-1.6, 1, 1),
                new THREE.Vector3(-2.4, 1.1, 1.3),
                0.08,
                0x00ff88,
                'lca',
                'OM2'
            );

            arteries.om3 = createArterySegment(
                new THREE.Vector3(-2, 0.6, 0),
                new THREE.Vector3(-2.6, 0.5, 0.3),
                0.07,
                0x00ff88,
                'lca',
                'OM3'
            );

            // Sistema Coronario Derecho

            // Coronaria Derecha (RCA)
            const rcaPoints = [
                new THREE.Vector3(0, 1.8, 2.2),
                new THREE.Vector3(0.8, 1.6, 2),
                new THREE.Vector3(1.6, 1.2, 1.4),
                new THREE.Vector3(2.1, 0.6, 0.5),
                new THREE.Vector3(2.2, -0.2, -0.5),
                new THREE.Vector3(2, -1, -1.2),
                new THREE.Vector3(1.3, -1.7, -1.6),
                new THREE.Vector3(0.5, -2.1, -1.5)
            ];
            arteries.rca = createCurvedArtery(rcaPoints, 0.14, 0x4444ff, 'rca', 'RCA');

            // Rama del Cono
            arteries.conus = createArterySegment(
                new THREE.Vector3(0.8, 1.6, 2),
                new THREE.Vector3(1.2, 1.8, 2.3),
                0.07,
                0x6666ff,
                'rca',
                'Cono'
            );

            // Rama del Nodo Sinusal
            arteries.sinus = createArterySegment(
                new THREE.Vector3(0.8, 1.6, 2),
                new THREE.Vector3(0.6, 2.1, 1.8),
                0.06,
                0x6666ff,
                'rca',
                'N.Sinusal'
            );

            // Rama Aguda Marginal
            arteries.am = createArterySegment(
                new THREE.Vector3(2.1, 0.6, 0.5),
                new THREE.Vector3(2.6, 0.7, 0.9),
                0.08,
                0x6666ff,
                'rca',
                'AM'
            );

            // Descendente Posterior (PDA)
            const pdaPoints = [
                new THREE.Vector3(0.5, -2.1, -1.5),
                new THREE.Vector3(0, -2.3, -1),
                new THREE.Vector3(-0.4, -2.4, -0.4),
                new THREE.Vector3(-0.6, -2.3, 0.3)
            ];
            arteries.pda = createCurvedArtery(pdaPoints, 0.1, 0x6666ff, 'rca', 'PDA');

            // Rama Posterolateral
            arteries.pl = createArterySegment(
                new THREE.Vector3(1.3, -1.7, -1.6),
                new THREE.Vector3(0.8, -2, -2.2),
                0.08,
                0x6666ff,
                'rca',
                'PL'
            );
        }

        function createArterySegment(start, end, radius, color, group, name) {
            const direction = new THREE.Vector3().subVectors(end, start);
            const length = direction.length();
            
            const geometry = new THREE.CylinderGeometry(radius, radius * 0.9, length, 16);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 100,
                specular: 0xffffff,
                emissive: color,
                emissiveIntensity: 0.1
            });
            
            const artery = new THREE.Mesh(geometry, material);
            artery.position.copy(start).add(direction.multiplyScalar(0.5));
            
            const axis = new THREE.Vector3(0, 1, 0);
            artery.quaternion.setFromUnitVectors(axis, direction.normalize());
            
            artery.userData = { 
                group: group, 
                name: name,
                start: start.clone(),
                end: end.clone()
            };
            
            heart.add(artery);
            return artery;
        }

        function createCurvedArtery(points, radius, color, group, name) {
            const curve = new THREE.CatmullRomCurve3(points);
            const tubeGeometry = new THREE.TubeGeometry(curve, 64, radius, 16, false);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 100,
                specular: 0xffffff,
                emissive: color,
                emissiveIntensity: 0.1
            });
            
            const artery = new THREE.Mesh(tubeGeometry, material);
            artery.userData = { 
                group: group, 
                name: name,
                curve: curve
            };
            
            heart.add(artery);
            return artery;
        }

        function createLabels() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;

            const labelPositions = [
                { name: 'LAD', pos: new THREE.Vector3(-1.1, 0, 2.6) },
                { name: 'LCx', pos: new THREE.Vector3(-2, 0.6, 0.2) },
                { name: 'RCA', pos: new THREE.Vector3(2.2, -0.2, -0.3) },
                { name: 'LM', pos: new THREE.Vector3(-0.5, 1.4, 2.6) }
            ];

            labelPositions.forEach(label => {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.fillStyle = '#00d4ff';
                context.font = 'Bold 48px Arial';
                context.textAlign = 'center';
                context.fillText(label.name, canvas.width / 2, canvas.height / 2 + 16);

                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ 
                    map: texture,
                    transparent: true,
                    opacity: 0.9
                });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.position.copy(label.pos);
                sprite.scale.set(1, 0.25, 1);
                sprite.userData.isLabel = true;
                
                labels.push(sprite);
                heart.add(sprite);
            });
        }

        function createStenosisMarkers() {
            stenosisData.forEach(stenosis => {
                const geometry = new THREE.SphereGeometry(0.15, 16, 16);
                const material = new THREE.MeshPhongMaterial({
                    color: 0xff4757,
                    emissive: 0xff0000,
                    emissiveIntensity: 0.5,
                    transparent: true,
                    opacity: 0.8
                });
                
                const marker = new THREE.Mesh(geometry, material);
                marker.position.copy(stenosis.position);
                marker.userData = {
                    isStenosis: true,
                    severity: stenosis.severity,
                    artery: stenosis.artery
                };
                marker.visible = false;
                
                stenosisMarkers.push(marker);
                heart.add(marker);
            });
        }

        function setupEventListeners() {
            const canvas = document.getElementById('canvas3d');

            canvas.addEventListener('mousedown', (e) => {
                controls.isDragging = true;
                controls.previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mousemove', (e) => {
                if (controls.isDragging && !measurementMode) {
                    const deltaX = e.clientX - controls.previousMousePosition.x;
                    const deltaY = e.clientY - controls.previousMousePosition.y;

                    heart.rotation.y += deltaX * controls.rotationSpeed;
                    heart.rotation.x += deltaY * controls.rotationSpeed;

                    controls.previousMousePosition = { x: e.clientX, y: e.clientY };
                    
                    updateRotationDisplay();
                }
            });

            canvas.addEventListener('mouseup', () => {
                controls.isDragging = false;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY * -0.01;
                controls.zoomLevel += delta;
                controls.zoomLevel = Math.max(8, Math.min(30, controls.zoomLevel));
                camera.position.z = controls.zoomLevel;
                updateZoomDisplay();
            });

            canvas.addEventListener('dblclick', () => {
                resetView();
            });

            window.addEventListener('resize', onWindowResize);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isRotating && !controls.isDragging) {
                heart.rotation.y += 0.003;
                updateRotationDisplay();
            }

            // Animar estenosis
            stenosisMarkers.forEach((marker, index) => {
                if (marker.visible) {
                    marker.scale.set(
                        1 + Math.sin(Date.now() * 0.003 + index) * 0.2,
                        1 + Math.sin(Date.now() * 0.003 + index) * 0.2,
                        1 + Math.sin(Date.now() * 0.003 + index) * 0.2
                    );
                }
            });

            renderer.render(scene, camera);
        }

        // Funciones de control
        function setAngiographicView(view) {
            const views = {
                'RAO30': { pos: [10, 3, 10], name: 'RAO 30¬∞' },
                'LAO45': { pos: [-12, 3, 10], name: 'LAO 45¬∞' },
                'RAO30_CRAN': { pos: [10, 12, 8], name: 'RAO 30¬∞ Craneal' },
                'LAO45_CRAN': { pos: [-12, 12, 8], name: 'LAO 45¬∞ Craneal' },
                'RAO30_CAUD': { pos: [10, -8, 10], name: 'RAO 30¬∞ Caudal' },
                'LAO45_CAUD': { pos: [-12, -8, 10], name: 'LAO 45¬∞ Caudal' },
                'AP_CRAN': { pos: [0, 18, 8], name: 'AP Craneal' },
                'AP_CAUD': { pos: [0, -15, 8], name: 'AP Caudal' },
                'LATERAL': { pos: [20, 0, 0], name: 'Lateral' },
                'SPIDER': { pos: [0, 20, 5], name: 'Spider View' }
            };

            if (views[view]) {
                camera.position.set(...views[view].pos);
                camera.lookAt(0, 0, 0);
                document.getElementById('currentView').textContent = views[view].name;
            }
        }

        function toggleArteryVisibility(type) {
            ['btnAll', 'btnLCA', 'btnRCA'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });

            if (type === 'all') {
                document.getElementById('btnAll').classList.add('active');
                document.getElementById('visibleArteries').textContent = 'Todas';
            } else if (type === 'lca') {
                document.getElementById('btnLCA').classList.add('active');
                document.getElementById('visibleArteries').textContent = 'Coronaria Izquierda';
            } else if (type === 'rca') {
                document.getElementById('btnRCA').classList.add('active');
                document.getElementById('visibleArteries').textContent = 'Coronaria Derecha';
            }

            heart.children.forEach(child => {
                if (child.userData.group) {
                    child.visible = type === 'all' || child.userData.group === type;
                }
            });
        }

        function toggleLabels() {
            const visible = document.getElementById('chkLabels').checked;
            labels.forEach(label => label.visible = visible);
        }

        function toggleHeart() {
            const visible = document.getElementById('chkHeart').checked;
            heart.children.forEach(child => {
                if (!child.userData.group && !child.userData.isLabel && !child.userData.isStenosis) {
                    child.visible = visible;
                }
            });
        }

        function toggleGrid() {
            const visible = document.getElementById('chkGrid').checked;
            let gridHelper = scene.getObjectByName('gridHelper');
            
            if (visible && !gridHelper) {
                gridHelper = new THREE.GridHelper(20, 20, 0x00d4ff, 0x444444);
                gridHelper.name = 'gridHelper';
                scene.add(gridHelper);
            } else if (!visible && gridHelper) {
                scene.remove(gridHelper);
            }
        }

        function toggleStenosis() {
            const visible = document.getElementById('chkStenosis').checked;
            stenosisMarkers.forEach(marker => marker.visible = visible);
        }

        function toggleRotation() {
            isRotating = !isRotating;
            const btn = document.getElementById('btnRotation');
            btn.textContent = isRotating ? '‚è∏Ô∏è Pausar Rotaci√≥n' : '‚ñ∂Ô∏è Reanudar Rotaci√≥n';
        }

        function resetView() {
            camera.position.set(0, 5, 15);
            camera.lookAt(0, 0, 0);
            heart.rotation.set(0, 0, 0);
            controls.zoomLevel = 15;
            updateRotationDisplay();
            updateZoomDisplay();
            document.getElementById('currentView').textContent = 'Frontal';
        }

        function toggleMeasurement() {
            measurementMode = !measurementMode;
            document.getElementById('currentMode').textContent = measurementMode ? 'Medici√≥n' : 'Visualizaci√≥n';
            document.getElementById('crosshair').style.display = measurementMode ? 'block' : 'none';
        }

        function updateHeartOpacity(value) {
            document.getElementById('heartOpacity').textContent = value + '%';
            heart.children.forEach(child => {
                if (!child.userData.group && !child.userData.isLabel) {
                    if (child.material) {
                        child.material.opacity = value / 100 * 0.5;
                    }
                }
            });
        }

        function updateArteryThickness(value) {
            document.getElementById('arteryThickness').textContent = value + '%';
            const scale = value / 100;
            heart.children.forEach(child => {
                if (child.userData.group) {
                    child.scale.set(scale, 1, scale);
                }
            });
        }

        function changeBackground(color) {
            scene.background = new THREE.Color(color);
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
            event.target.classList.add('active');
        }

        function addCatheter(type) {
            if (type === 'clear') {
                catheters.forEach(cath => heart.remove(cath));
                catheters = [];
                currentCatheter = null;
                return;
            }

            // Remover cat√©ter anterior
            if (currentCatheter) {
                heart.remove(currentCatheter);
            }

            // Crear nuevo cat√©ter
            const catheterGeometry = new THREE.CylinderGeometry(0.03, 0.03, 5, 8);
            const catheterMaterial = new THREE.MeshPhongMaterial({
                color: 0xffaa00,
                emissive: 0xff8800,
                emissiveIntensity: 0.3
            });
            
            currentCatheter = new THREE.Mesh(catheterGeometry, catheterMaterial);
            currentCatheter.position.set(0, -3, 2);
            currentCatheter.userData.type = type;
            
            heart.add(currentCatheter);
            catheters.push(currentCatheter);
            
            document.getElementById('catheterSlider').value = 0;
            updateCatheterProgress(0);
        }

        function updateCatheterProgress(value) {
            document.getElementById('catheterProgress').textContent = value + '%';
            if (currentCatheter) {
                const progress = value / 100;
                currentCatheter.position.y = -3 + (progress * 4);
            }
        }

        function clearMeasurements() {
            measurements = [];
            document.getElementById('measurementsList').innerHTML = '<p style="text-align: center; color: #666; font-size: 0.8rem;">No hay mediciones</p>';
        }

        function exportImage() {
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `coronarias-3d-${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function updateRotationDisplay() {
            const angle = Math.round((heart.rotation.y * 180 / Math.PI) % 360);
            document.getElementById('rotationAngle').textContent = angle + '¬∞';
        }

        function updateZoomDisplay() {
            const zoom = Math.round((30 - controls.zoomLevel) / 22 * 100 + 100);
            document.getElementById('zoomLevel').textContent = zoom + '%';
        }

        function onWindowResize() {
            const canvas = document.getElementById('canvas3d');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }

        // Iniciar cuando cargue la p√°gina
        window.addEventListener('load', init);
    </script>
</body>
</html>
