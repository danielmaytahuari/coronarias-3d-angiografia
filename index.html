<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlaci√≥n 3D-2D Angiograf√≠a Coronaria | Premium</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            overflow: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #00d4ff;
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #00d4ff;
            display: inline-block;
        }

        .premium-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr auto;
            height: calc(100vh - 80px);
            gap: 10px;
            padding: 10px;
        }

        .viewer-3d {
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #00d4ff;
        }

        .viewer-2d {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ff4757;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .viewer-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 10;
        }

        .viewer-3d .viewer-label {
            color: #00d4ff;
            border: 1px solid #00d4ff;
        }

        .viewer-2d .viewer-label {
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        #canvas3d {
            width: 100%;
            height: 100%;
            display: block;
        }

        .angio-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .angio-video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .video-controls {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            border: 1px solid #ff4757;
        }

        .video-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.3s;
        }

        .video-btn:hover {
            color: #ff4757;
            transform: scale(1.2);
        }

        .frame-counter {
            color: #00d4ff;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .placeholder-text {
            color: #666;
            text-align: center;
            padding: 20px;
        }

        .placeholder-text h3 {
            color: #ff4757;
            margin-bottom: 10px;
        }

        .error-message {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid #ff4757;
            padding: 15px;
            border-radius: 8px;
            margin: 10px;
        }

        .controls-panel {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #00d4ff;
            display: flex;
            gap: 30px;
            overflow-x: auto;
        }

        .control-section {
            min-width: 200px;
        }

        .control-section h3 {
            color: #00d4ff;
            font-size: 0.9rem;
            margin-bottom: 10px;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 5px;
        }

        .projection-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .projection-btn {
            padding: 10px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .projection-btn:hover {
            background: rgba(0, 212, 255, 0.4);
            transform: translateY(-2px);
        }

        .projection-btn.active {
            background: #ff4757;
            border-color: #ff4757;
        }

        .view-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .view-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .view-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .view-btn.active {
            background: #00d4ff;
            border-color: #00d4ff;
            color: #000;
        }

        .angle-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            border: 1px solid #ffd700;
            color: #ffd700;
            font-weight: bold;
        }

        .case-selector {
            min-width: 250px;
        }

        .case-option {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .case-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00d4ff;
        }

        .case-option.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .case-title {
            font-weight: bold;
            color: #00d4ff;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .case-desc {
            font-size: 0.75rem;
            color: #aaa;
        }

        .annotation {
            position: absolute;
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 20;
        }

        .sync-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 0, 0.8);
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .video-status {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(255, 165, 0, 0.9);
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        ::-webkit-scrollbar {
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 4px;
        }

        .setup-instructions {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid #ffa500;
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            color: #ffa500;
        }

        .setup-instructions h3 {
            margin-bottom: 15px;
            color: #ffd700;
        }

        .setup-instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-instructions code {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Correlaci√≥n 3D-2D Angiograf√≠a Coronaria <span class="premium-badge">PREMIUM PRO</span></h1>
    </div>

    <div class="container">
        <!-- Visor 3D -->
        <div class="viewer-3d">
            <div class="viewer-label">üéØ MODELO 3D</div>
            <div class="sync-indicator" id="syncIndicator">‚óè SINCRONIZADO</div>
            <div class="video-status" id="videoStatus" style="display: none;">‚ö†Ô∏è Verificando video...</div>
            <canvas id="canvas3d"></canvas>
            <div class="angle-info" id="angleInfo">Vista: Inicial</div>
        </div>

        <!-- Visor 2D (Angiograf√≠a) -->
        <div class="viewer-2d">
            <div class="viewer-label">üì∏ ANGIOGRAF√çA</div>
            <div id="angioViewer">
                <div class="setup-instructions">
                    <h3>‚ö†Ô∏è INSTRUCCIONES DE CONFIGURACI√ìN</h3>
                    <p style="margin-bottom: 15px;">Los videos no se reproducen porque las URLs a√∫n no est√°n configuradas. Sigue estos pasos:</p>
                    <ol>
                        <li>Sube tus videos MP4 a tu repositorio de GitHub en una carpeta llamada <code>/videos/</code></li>
                        <li>Aseg√∫rate de que los nombres coincidan:
                            <ul style="margin-left: 20px; margin-top: 8px;">
                                <li><code>rao-30.mp4</code></li>
                                <li><code>lao-45.mp4</code></li>
                                <li><code>spider-view.mp4</code>, etc.</li>
                            </ul>
                        </li>
                        <li>Actualiza la variable <code>BASE_VIDEO_URL</code> en el c√≥digo (l√≠nea ~273) con la URL de tu repo</li>
                        <li>O usa videos de ejemplo desde URLs p√∫blicas temporales</li>
                    </ol>
                    <p style="margin-top: 15px; font-size: 0.85rem;">
                        <strong>üìå Ejemplo de URL correcta:</strong><br>
                        <code>https://raw.githubusercontent.com/TU-USUARIO/TU-REPO/main/videos/</code>
                    </p>
                    <p style="margin-top: 10px; color: #00d4ff;">
                        üëâ Mientras tanto, puedes probar el modelo 3D interactivo a la izquierda
                    </p>
                </div>
            </div>
        </div>

        <!-- Panel de controles -->
        <div class="controls-panel">
            <!-- Casos cl√≠nicos -->
            <div class="case-selector control-section">
                <h3>üìã Casos Cl√≠nicos</h3>
                <div class="case-option active" onclick="selectCase('normal')">
                    <div class="case-title">Anatom√≠a Normal</div>
                    <div class="case-desc">Dominancia derecha est√°ndar</div>
                </div>
                <div class="case-option" onclick="selectCase('lad-stenosis')">
                    <div class="case-title">Estenosis LAD Proximal</div>
                    <div class="case-desc">90% antes de D1</div>
                </div>
                <div class="case-option" onclick="selectCase('lm-disease')">
                    <div class="case-title">Enfermedad Tronco Com√∫n</div>
                    <div class="case-desc">Estenosis 70% distal</div>
                </div>
                <div class="case-option" onclick="selectCase('rca-cto')">
                    <div class="case-title">CTO RCA Media</div>
                    <div class="case-desc">Oclusi√≥n total cr√≥nica</div>
                </div>
            </div>

            <!-- Proyecciones angiogr√°ficas -->
            <div class="control-section">
                <h3>üìê Proyecciones Angiogr√°ficas</h3>
                <div class="projection-buttons">
                    <button class="projection-btn" onclick="setProjection('RAO30')">RAO 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO45')">LAO 45¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO60')">LAO 60¬∞</button>
                    <button class="projection-btn" onclick="setProjection('RAO30-CRAN30')">RAO 30¬∞ CRAN 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO45-CRAN30')">LAO 45¬∞ CRAN 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('LAO45-CAUD30')">LAO 45¬∞ CAUD 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('AP-CRAN30')">AP CRAN 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('AP-CAUD30')">AP CAUD 30¬∞</button>
                    <button class="projection-btn" onclick="setProjection('SPIDER')">Spider View</button>
                    <button class="projection-btn" onclick="setProjection('LATERAL')">Lateral</button>
                </div>
            </div>

            <!-- Controles de visualizaci√≥n -->
            <div class="control-section">
                <h3>‚öôÔ∏è Visualizaci√≥n</h3>
                <div class="view-controls">
                    <button class="view-btn active" id="btnAll" onclick="toggleArtery('all')">Todas las Arterias</button>
                    <button class="view-btn" id="btnLCA" onclick="toggleArtery('lca')">Sistema Izquierdo</button>
                    <button class="view-btn" id="btnRCA" onclick="toggleArtery('rca')">Sistema Derecho</button>
                    <button class="view-btn" onclick="toggleHeart()">ü´Ä Coraz√≥n On/Off</button>
                    <button class="view-btn" onclick="toggleRotation()" id="btnRotate">‚ñ∂Ô∏è Rotar</button>
                    <button class="view-btn" onclick="resetCamera()">üéØ Reset C√°mara</button>
                </div>
            </div>

            <!-- Info educativa -->
            <div class="control-section">
                <h3>üí° Informaci√≥n</h3>
                <div style="font-size: 0.75rem; color: #aaa; line-height: 1.5;">
                    <p style="margin-bottom: 8px;">
                        <strong style="color: #00d4ff;">Sincronizaci√≥n 3D-2D:</strong>
                    </p>
                    <ul style="margin-left: 15px;">
                        <li>Las proyecciones replican √°ngulos reales de sala</li>
                        <li>Comparaci√≥n directa anatom√≠a vs imagen</li>
                        <li>Identificaci√≥n de segmentos arteriales</li>
                    </ul>
                    <p style="margin-top: 12px; color: #ffa500;">
                        <strong>‚ö†Ô∏è Estado:</strong> Modelo 3D funcional<br>
                        Videos: Pendiente de configuraci√≥n
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============================================================================
        // CONFIGURACI√ìN DE VIDEOS - ACTUALIZA ESTA SECCI√ìN
        // ============================================================================
        
        // OPCI√ìN 1: Usa tu propio repositorio de GitHub
        const BASE_VIDEO_URL = 'https://raw.githubusercontent.com/danielmaytahuari/coronarias-3d-angiografia/main/videos/';
        
        // OPCI√ìN 2: Videos de demostraci√≥n (descomentar para probar)
        // const BASE_VIDEO_URL = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/';
        
        const VIDEO_FILES = {
            'RAO30': 'rao-30.mp4',
            'LAO45': 'lao-45.mp4',
            'LAO60': 'lao-60.mp4',
            'RAO30-CRAN30': 'rao-30-cran-30.mp4',
            'LAO45-CRAN30': 'lao-45-cran-30.mp4',
            'LAO45-CAUD30': 'lao-45-caud-30.mp4',
            'AP-CRAN30': 'ap-cran-30.mp4',
            'AP-CAUD30': 'ap-caud-30.mp4',
            'SPIDER': 'spider-view.mp4',
            'LATERAL': 'lateral.mp4'
        };

        // Para testing r√°pido, puedes usar un video de prueba conocido:
        const TEST_VIDEO_URL = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';

        // ============================================================================
        // VARIABLES GLOBALES
        // ============================================================================
        
        let scene, camera, renderer, coronaries;
        let isRotating = false;
        let currentCase = 'normal';
        let currentProjection = null;
        let showAnnotations = false;

        const projectionDatabase = {
            'normal': {
                'RAO30': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['RAO30'],
                    description: 'RAO 30¬∞ - Visualiza RCA proximal y media, bifurcaci√≥n LAD/Cx',
                    cameraPos: { x: 12, y: 3, z: 12 },
                    loop: true
                },
                'LAO45': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['LAO45'],
                    description: 'LAO 45¬∞ - LAD completa sin sobreposici√≥n',
                    cameraPos: { x: -12, y: 3, z: 12 },
                    loop: true
                },
                'LAO60': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['LAO60'],
                    description: 'LAO 60¬∞ - Separaci√≥n √≥ptima LAD y diagonales',
                    cameraPos: { x: -15, y: 3, z: 10 },
                    loop: true
                },
                'RAO30-CRAN30': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['RAO30-CRAN30'],
                    description: 'RAO 30¬∞ CRAN 30¬∞ - Bifurcaci√≥n tronco com√∫n (GOLD STANDARD)',
                    cameraPos: { x: 10, y: 12, z: 10 },
                    loop: true
                },
                'LAO45-CRAN30': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['LAO45-CRAN30'],
                    description: 'LAO 45¬∞ CRAN 30¬∞ - LAD proximal y medio sin foreshortening',
                    cameraPos: { x: -10, y: 12, z: 10 },
                    loop: true
                },
                'LAO45-CAUD30': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['LAO45-CAUD30'],
                    description: 'LAO 45¬∞ CAUD 30¬∞ - Visualiza LCx y marginales obtusas',
                    cameraPos: { x: -10, y: -10, z: 12 },
                    loop: true
                },
                'AP-CRAN30': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['AP-CRAN30'],
                    description: 'AP CRAN 30¬∞ - LAD distal y apex',
                    cameraPos: { x: 0, y: 15, z: 12 },
                    loop: true
                },
                'AP-CAUD30': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['AP-CAUD30'],
                    description: 'AP CAUD 30¬∞ - RCA media y distal',
                    cameraPos: { x: 0, y: -12, z: 15 },
                    loop: true
                },
                'SPIDER': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['SPIDER'],
                    description: 'Spider View - Vista superior de todas las arterias',
                    cameraPos: { x: 0, y: 25, z: 0 },
                    loop: true
                },
                'LATERAL': {
                    type: 'video',
                    video: BASE_VIDEO_URL + VIDEO_FILES['LATERAL'],
                    description: 'Vista Lateral - Perfil puro',
                    cameraPos: { x: 20, y: 0, z: 0 },
                    loop: true
                }
            }
        };

        // ============================================================================
        // INICIALIZACI√ìN DE THREE.JS
        // ============================================================================

        function init() {
            const canvas = document.getElementById('canvas3d');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1929);

            camera = new THREE.PerspectiveCamera(
                45,
                canvas.clientWidth / canvas.clientHeight,
                0.1,
                1000
            );
            camera.position.set(0, 8, 20);

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true 
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Luces
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
            mainLight.position.set(10, 10, 10);
            scene.add(mainLight);

            const fillLight = new THREE.DirectionalLight(0x4488ff, 0.3);
            fillLight.position.set(-10, -10, -10);
            scene.add(fillLight);

            coronaries = new THREE.Group();
            scene.add(coronaries);

            createSimpleCoronaryModel();

            const gridHelper = new THREE.GridHelper(30, 30, 0x00d4ff, 0x003344);
            gridHelper.position.y = -8;
            scene.add(gridHelper);

            // Controles de c√°mara
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;
                    
                    coronaries.rotation.y += deltaX * 0.01;
                    coronaries.rotation.x += deltaY * 0.01;
                    
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.02;
                camera.position.z = Math.max(8, Math.min(40, camera.position.z));
            });

            window.addEventListener('resize', onWindowResize);

            animate();
        }

        function createSimpleCoronaryModel() {
            // Coraz√≥n simplificado
            const heartGeometry = new THREE.SphereGeometry(3, 32, 32);
            heartGeometry.scale(1, 1.3, 0.9);
            const heartMaterial = new THREE.MeshPhongMaterial({
                color: 0x8b0000,
                transparent: true,
                opacity: 0.25
            });
            const heart = new THREE.Mesh(heartGeometry, heartMaterial);
            heart.name = 'heartMesh';
            coronaries.add(heart);

            // Sistema izquierdo (LCA) - Rojo
            const lmPoints = [
                new THREE.Vector3(-1, 3, 2),
                new THREE.Vector3(-1.5, 2.5, 2.2)
            ];
            createArtery(lmPoints, 0.18, 0xff0000, 'lca');

            const ladPoints = [
                new THREE.Vector3(-1.5, 2.5, 2.2),
                new THREE.Vector3(-1.8, 1, 2.5),
                new THREE.Vector3(-1.5, -1, 2.6),
                new THREE.Vector3(-1, -3, 2.4),
                new THREE.Vector3(-0.6, -4.5, 2.0)
            ];
            createArtery(ladPoints, 0.14, 0xff0000, 'lca');

            const lcxPoints = [
                new THREE.Vector3(-1.5, 2.5, 2.2),
                new THREE.Vector3(-2.5, 2, 0.5),
                new THREE.Vector3(-3.5, 0.5, -1),
                new THREE.Vector3(-3.2, -1, -1.8)
            ];
            createArtery(lcxPoints, 0.12, 0xff0000, 'lca');

            // Sistema derecho (RCA) - Azul
            const rcaPoints = [
                new THREE.Vector3(1, 3, 2),
                new THREE.Vector3(3, 2, 0.5),
                new THREE.Vector3(4, 0, -1),
                new THREE.Vector3(3.5, -1.5, -2),
                new THREE.Vector3(2, -2.5, -2.3)
            ];
            createArtery(rcaPoints, 0.14, 0x4444ff, 'rca');

            const pdaPoints = [
                new THREE.Vector3(2, -2.5, -2.3),
                new THREE.Vector3(0.5, -3.5, -2),
                new THREE.Vector3(-0.5, -4.5, -1.5)
            ];
            createArtery(pdaPoints, 0.11, 0x6666ff, 'rca');
        }

        function createArtery(points, radius, color, group) {
            const curve = new THREE.CatmullRomCurve3(points);
            const geometry = new THREE.TubeGeometry(curve, 64, radius, 16, false);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 100,
                emissive: color,
                emissiveIntensity: 0.1
            });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.userData.group = group;
            coronaries.add(mesh);
        }

        // ============================================================================
        // FUNCI√ìN PRINCIPAL: CAMBIAR PROYECCI√ìN CON DETECCI√ìN DE ERRORES
        // ============================================================================

        async function checkVideoExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function setProjection(projection) {
            currentProjection = projection;
            
            // Actualizar botones
            document.querySelectorAll('.projection-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const projData = projectionDatabase[currentCase]?.[projection];
            
            if (projData) {
                // Mostrar indicador de carga
                const videoStatus = document.getElementById('videoStatus');
                videoStatus.style.display = 'block';
                videoStatus.textContent = '‚è≥ Cargando video...';
                videoStatus.style.background = 'rgba(255, 165, 0, 0.9)';

                // Sincronizar c√°mara 3D
                camera.position.set(
                    projData.cameraPos.x,
                    projData.cameraPos.y,
                    projData.cameraPos.z
                );
                camera.lookAt(0, 0, 0);
                
                // Verificar si el video existe
                const videoExists = await checkVideoExists(projData.video);
                
                if (videoExists) {
                    // Video encontrado - renderizar
                    const viewerHTML = `
                        <video class="angio-video" id="angioVideo" 
                               ${projData.loop ? 'loop' : ''} 
                               controls
                               autoplay
                               muted
                               playsinline
                               crossorigin="anonymous">
                            <source src="${projData.video}" type="video/mp4">
                            Tu navegador no soporta video HTML5
                        </video>
                        <div class="video-controls">
                            <button class="video-btn" onclick="toggleVideo()" title="Play/Pause">‚ñ∂Ô∏è</button>
                            <button class="video-btn" onclick="restartVideo()" title="Reiniciar">‚èÆÔ∏è</button>
                            <button class="video-btn" onclick="slowMotion()" title="C√°mara lenta">üêå</button>
                            <button class="video-btn" onclick="toggleMute()" title="Silenciar">üîá</button>
                        </div>
                        <div class="annotation" style="bottom: 80px; left: 50%; transform: translateX(-50%);">
                            ${projData.description}
                        </div>
                    `;

                    document.getElementById('angioViewer').innerHTML = viewerHTML;

                    const video = document.getElementById('angioVideo');
                    
                    video.addEventListener('loadeddata', () => {
                        videoStatus.textContent = '‚úÖ Video cargado';
                        videoStatus.style.background = 'rgba(0, 255, 0, 0.9)';
                        setTimeout(() => {
                            videoStatus.style.display = 'none';
                        }, 2000);
                    });

                    video.addEventListener('error', (e) => {
                        showVideoError(projection, projData.video);
                    });

                    // Intentar reproducir
                    try {
                        await video.play();
                    } catch (e) {
                        console.log('Autoplay bloqueado - el usuario debe hacer clic');
                    }

                } else {
                    // Video no encontrado
                    showVideoError(projection, projData.video);
                }

                document.getElementById('angleInfo').textContent = `Vista: ${projection}`;

                // Indicador de sincronizaci√≥n
                const syncIndicator = document.getElementById('syncIndicator');
                syncIndicator.style.background = 'rgba(0, 255, 0, 0.9)';
                setTimeout(() => {
                    syncIndicator.style.background = 'rgba(0, 255, 0, 0.8)';
                }, 200);
            }
        }

        function showVideoError(projection, videoUrl) {
            const videoStatus = document.getElementById('videoStatus');
            videoStatus.textContent = '‚ùå Video no encontrado';
            videoStatus.style.background = 'rgba(255, 71, 87, 0.9)';
            
            document.getElementById('angioViewer').innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è Video no disponible: ${projection}</h3>
                    <p style="margin: 10px 0; font-size: 0.85rem;">
                        <strong>URL intentada:</strong><br>
                        <code style="font-size: 0.75rem; word-break: break-all;">${videoUrl}</code>
                    </p>
                    <p style="margin-top: 15px; color: #ffa500;">
                        <strong>Posibles soluciones:</strong>
                    </p>
                    <ul style="margin: 10px 0 10px 20px; text-align: left; font-size: 0.85rem;">
                        <li>Verifica que el archivo <code>${projection.toLowerCase()}.mp4</code> exista en tu repositorio</li>
                        <li>Aseg√∫rate de que la carpeta sea <code>/videos/</code></li>
                        <li>Comprueba que la URL de GitHub sea correcta (debe ser raw.githubusercontent.com)</li>
                        <li>Los archivos deben ser p√∫blicos en el repositorio</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 0.85rem;">
                        <strong>üìå La sincronizaci√≥n 3D s√≠ est√° funcionando</strong> - El modelo 3D muestra la proyecci√≥n correcta.
                    </p>
                </div>
            `;
        }

        // ============================================================================
        // CONTROLES DE VIDEO
        // ============================================================================

        function toggleVideo() {
            const video = document.getElementById('angioVideo');
            if (video) {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            }
        }

        function restartVideo() {
            const video = document.getElementById('angioVideo');
            if (video) {
                video.currentTime = 0;
                video.play();
            }
        }

        function slowMotion() {
            const video = document.getElementById('angioVideo');
            if (video) {
                video.playbackRate = video.playbackRate === 1 ? 0.5 : 1;
            }
        }

        function toggleMute() {
            const video = document.getElementById('angioVideo');
            if (video) {
                video.muted = !video.muted;
            }
        }

        // ============================================================================
        // OTRAS FUNCIONES DE CONTROL
        // ============================================================================

        function selectCase(caseId) {
            currentCase = caseId;
            
            document.querySelectorAll('.case-option').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.case-option').classList.add('active');

            currentProjection = null;
            document.querySelectorAll('.projection-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('angioViewer').innerHTML = `
                <div class="placeholder-text">
                    <h3>Caso seleccionado: ${caseId}</h3>
                    <p>Selecciona una proyecci√≥n angiogr√°fica</p>
                </div>
            `;
        }

        function toggleArtery(type) {
            document.getElementById('btnAll').classList.remove('active');
            document.getElementById('btnLCA').classList.remove('active');
            document.getElementById('btnRCA').classList.remove('active');
            
            if (type === 'all') {
                document.getElementById('btnAll').classList.add('active');
            } else if (type === 'lca') {
                document.getElementById('btnLCA').classList.add('active');
            } else if (type === 'rca') {
                document.getElementById('btnRCA').classList.add('active');
            }
            
            coronaries.children.forEach(child => {
                if (child.userData.group) {
                    child.visible = (type === 'all' || child.userData.group === type);
                }
            });
        }

        function toggleHeart() {
            coronaries.children.forEach(child => {
                if (child.name === 'heartMesh') {
                    child.visible = !child.visible;
                }
            });
        }

        function toggleRotation() {
            isRotating = !isRotating;
            document.getElementById('btnRotate').textContent = isRotating ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Rotar';
        }

        function resetCamera() {
            camera.position.set(0, 8, 20);
            camera.lookAt(0, 0, 0);
            coronaries.rotation.set(0, 0, 0);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isRotating) {
                coronaries.rotation.y += 0.003;
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const canvas = document.getElementById('canvas3d');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }

        // ============================================================================
        // INICIAR APLICACI√ìN
        // ============================================================================

        window.addEventListener('load', init);

        // Log de diagn√≥stico
        console.log('%cüè• Sistema de Angiograf√≠a 3D-2D Cargado', 'color: #00d4ff; font-size: 16px; font-weight: bold;');
        console.log('Base URL de videos:', BASE_VIDEO_URL);
        console.log('Archivos de video configurados:', VIDEO_FILES);
    </script>
</body>
</html>
